name: 'Docker Setup'
description: 'Setup Docker and authenticate to container registries'
inputs:
  registry:
    description: 'Container registry to authenticate (dockerhub, ghcr, ecr, acr)'
    required: false
    default: 'dockerhub'
  registry-url:
    description: 'Custom registry URL (optional, auto-detected for common registries)'
    required: false
    default: ''
  username:
    description: 'Registry username'
    required: false
    default: ''
  password:
    description: 'Registry password or token'
    required: false
    default: ''
  aws-region:
    description: 'AWS region for ECR (required when using ECR)'
    required: false
    default: 'us-east-1'
  azure-tenant-id:
    description: 'Azure tenant ID for ACR (required when using ACR with service principal)'
    required: false
    default: ''
  buildx-install:
    description: 'Install Docker Buildx'
    required: false
    default: 'true'
  qemu-install:
    description: 'Install QEMU for multi-platform builds'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      if: inputs.buildx-install == 'true'
      uses: docker/setup-buildx-action@v3
      shell: bash

    - name: Set up QEMU
      if: inputs.qemu-install == 'true'
      uses: docker/setup-qemu-action@v3
      shell: bash

    - name: Determine registry URL
      id: registry-config
      shell: bash
      run: |
        REGISTRY_URL="${{ inputs.registry-url }}"
        
        if [ -z "$REGISTRY_URL" ]; then
          case "${{ inputs.registry }}" in
            dockerhub)
              REGISTRY_URL="docker.io"
              ;;
            ghcr)
              REGISTRY_URL="ghcr.io"
              ;;
            ecr)
              REGISTRY_URL="${{ inputs.aws-region }}.dkr.ecr.amazonaws.com"
              ;;
            acr)
              echo "::error::ACR registry URL must be provided via registry-url input"
              exit 1
              ;;
            *)
              echo "::error::Unsupported registry: ${{ inputs.registry }}"
              exit 1
              ;;
          esac
        fi
        
        echo "registry-url=$REGISTRY_URL" >> $GITHUB_OUTPUT
        echo "Registry URL: $REGISTRY_URL"

    - name: Login to Docker Hub
      if: inputs.registry == 'dockerhub' && inputs.username != '' && inputs.password != ''
      uses: docker/login-action@v3
      with:
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}
      shell: bash

    - name: Login to GitHub Container Registry
      if: inputs.registry == 'ghcr' && inputs.username != '' && inputs.password != ''
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}
      shell: bash

    - name: Configure AWS credentials
      if: inputs.registry == 'ecr'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: ${{ inputs.aws-region }}
      shell: bash

    - name: Login to Amazon ECR
      if: inputs.registry == 'ecr'
      uses: aws-actions/amazon-ecr-login@v2
      shell: bash

    - name: Login to Azure Container Registry
      if: inputs.registry == 'acr' && inputs.username != '' && inputs.password != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ steps.registry-config.outputs.registry-url }}
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}
      shell: bash

outputs:
  registry-url:
    description: 'The container registry URL'
    value: ${{ steps.registry-config.outputs.registry-url }}
