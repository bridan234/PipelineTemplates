name: React CI/CD Pipeline

on:
  pull_request:
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      - '.github/workflows/react-pipeline.yml'
  push:
    branches:
      - develop
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      - '.github/workflows/react-pipeline.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'build'
        options:
          - build
          - deploy
          - build-and-deploy
      run-tests:
        description: 'Run tests'
        required: false
        type: boolean
        default: true
      run-lint:
        description: 'Run linting'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  id-token: write
  actions: write
  checks: write
  pages: write

env:
  NODE_VERSION: '20.x'
  PACKAGE_MANAGER: 'npm'
  WORKING_DIRECTORY: './'

jobs:
  # Step 1: Build & Test
  build:
    name: Build & Test
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'push' || 
      github.event.inputs.action == 'build' || 
      github.event.inputs.action == 'build-and-deploy'
    uses: ./.github/workflows/react/build.yml
    with:
      node-version: ${{ vars.NODE_VERSION || '20.x' }}
      package-manager: ${{ vars.PACKAGE_MANAGER || 'npm' }}
      working-directory: ${{ vars.WORKING_DIRECTORY || './' }}
      run-tests: ${{ github.event.inputs.run-tests != 'false' }}
      run-lint: ${{ github.event.inputs.run-lint != 'false' }}
      collect-coverage: true
      coverage-threshold: '80'
    secrets: inherit

  # Step 2: Security Scan
  security-scan:
    name: Security Scan
    needs: [build]
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'push' || 
      github.event.inputs.action != 'build'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION || '20.x' }}

      - name: Run npm audit
        shell: bash
        run: |
          echo "ðŸ”’ Running security audit..."
          npm audit --audit-level=moderate || true
          echo "âœ… Security audit completed"

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # Step 3: Lighthouse CI
  lighthouse:
    name: Lighthouse CI
    needs: [build]
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.run_id }}
          path: ./build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: './.lighthouserc.json'

  # Step 4: Build Summary
  build-summary:
    name: Build Summary
    needs: [build, security-scan, lighthouse]
    if: always() && needs.build.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        shell: bash
        run: |
          echo "## Build Pipeline Summary ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.build.outputs.build-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests:** ${{ needs.build.outputs.test-result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** ${{ needs.build.outputs.coverage-percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan:** ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lighthouse:** ${{ needs.lighthouse.result }}" >> $GITHUB_STEP_SUMMARY

  # Step 5: Approval Gate (for production deployments)
  approve:
    name: Approve Deployment
    needs: [build, security-scan]
    if: |
      github.event_name != 'pull_request' && 
      (github.event.inputs.action == 'deploy' || github.event.inputs.action == 'build-and-deploy') &&
      github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Approval Gate
        run: |
          echo "â³ Waiting for approval to deploy to ${{ github.event.inputs.environment }}"
          echo "âœ… Deployment approved"

  # Step 6: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    needs: [build, security-scan]
    if: |
      github.event_name != 'pull_request' && 
      (github.event.inputs.action == 'deploy' || github.event.inputs.action == 'build-and-deploy') &&
      github.event.inputs.environment == 'staging'
    uses: ./.github/workflows/react/deploy.yml
    with:
      environment: staging
      node-version: ${{ vars.NODE_VERSION || '20.x' }}
      package-manager: ${{ vars.PACKAGE_MANAGER || 'npm' }}
      working-directory: ${{ vars.WORKING_DIRECTORY || './' }}
      deployment-type: ${{ vars.STAGING_DEPLOYMENT_TYPE || 's3' }}
      s3-bucket: ${{ vars.STAGING_S3_BUCKET }}
      cloudfront-distribution-id: ${{ vars.STAGING_CLOUDFRONT_ID }}
      azure-storage-account: ${{ vars.STAGING_AZURE_STORAGE_ACCOUNT }}
      netlify-site-id: ${{ vars.STAGING_NETLIFY_SITE_ID }}
      env-file: '.env.staging'
      public-url: ${{ vars.STAGING_PUBLIC_URL }}
    secrets: inherit

  # Step 7: Deploy to Production
  deploy-production:
    name: Deploy to Production
    needs: [build, security-scan, approve]
    if: |
      github.event_name != 'pull_request' && 
      (github.event.inputs.action == 'deploy' || github.event.inputs.action == 'build-and-deploy') &&
      github.event.inputs.environment == 'production'
    uses: ./.github/workflows/react/deploy.yml
    with:
      environment: production
      node-version: ${{ vars.NODE_VERSION || '20.x' }}
      package-manager: ${{ vars.PACKAGE_MANAGER || 'npm' }}
      working-directory: ${{ vars.WORKING_DIRECTORY || './' }}
      deployment-type: ${{ vars.PRODUCTION_DEPLOYMENT_TYPE || 's3' }}
      s3-bucket: ${{ vars.PRODUCTION_S3_BUCKET }}
      cloudfront-distribution-id: ${{ vars.PRODUCTION_CLOUDFRONT_ID }}
      azure-storage-account: ${{ vars.PRODUCTION_AZURE_STORAGE_ACCOUNT }}
      netlify-site-id: ${{ vars.PRODUCTION_NETLIFY_SITE_ID }}
      env-file: '.env.production'
      public-url: ${{ vars.PRODUCTION_PUBLIC_URL }}
    secrets: inherit

  # Step 8: Smoke Tests
  smoke-tests:
    name: Smoke Tests
    needs: [deploy-staging, deploy-production]
    if: |
      always() && 
      (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smoke tests
        shell: bash
        run: |
          DEPLOYMENT_URL="${{ needs.deploy-staging.outputs.deployment-url || needs.deploy-production.outputs.deployment-url }}"
          echo "ðŸ§ª Running smoke tests against: $DEPLOYMENT_URL"
          
          # Basic health check
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL" || echo "000")
          
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… Smoke tests passed - Application is accessible (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Smoke tests failed - Application not accessible (HTTP $HTTP_STATUS)"
            exit 1
          fi

  # Step 9: Deployment Summary
  deployment-summary:
    name: Deployment Summary
    needs: [deploy-staging, deploy-production, smoke-tests]
    if: always() && (needs.deploy-staging.result != 'skipped' || needs.deploy-production.result != 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        shell: bash
        run: |
          echo "## Deployment Pipeline Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-staging.result }}" != "skipped" ]; then
            echo "### Staging Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** ${{ needs.deploy-staging.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **URL:** [${{ needs.deploy-staging.outputs.deployment-url }}](${{ needs.deploy-staging.outputs.deployment-url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy-production.result }}" != "skipped" ]; then
            echo "### Production Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** ${{ needs.deploy-production.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **URL:** [${{ needs.deploy-production.outputs.deployment-url }}](${{ needs.deploy-production.outputs.deployment-url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
